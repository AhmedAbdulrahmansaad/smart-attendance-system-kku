# ๐ง ุญู ุฎุทุฃ ุงูุชุณุฌูู ุงูููุฑุฑ (Duplicate Key Error)

**๐ ุงูุชุงุฑูุฎ:** 11 ุฏูุณูุจุฑ 2025  
**โ ุงูุฎุทุฃ:** `duplicate key value violates unique constraint "profiles_pkey"`

---

## ๐ฏ ูุง ูู ุงููุดููุฉุ

ุนูุฏ ูุญุงููุฉ ุงูุชุณุฌููุ ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:

```
โ API error for /signup: {
  "error": "Failed to create profile",
  "details": "duplicate key value violates unique constraint \"profiles_pkey\""
}
```

**ุงูุณุจุจ:**  
ุงููุณุชุฎุฏู ููุฌูุฏ ุจุงููุนู ูู `auth.users` ูููู ุนูุฏ ูุญุงููุฉ ุฅูุดุงุก `profile` ููุดู ูุฃู ุงูู ID ููุฌูุฏ ูุณุจูุงู.

---

## โ ุงูุญู (ุชู ุชุทุจููู)

ุชู ุฅุตูุงุญ ุงูููุฏ ูู `/supabase/functions/server/index.tsx` ุจุฅุถุงูุฉ:

### 1. ูุญุต ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุจู ุงูุฅูุดุงุก
```typescript
// First, check if email already exists in profiles table
console.log('๐ Checking if email exists in profiles...');
const { data: existingEmailProfile } = await supabase
  .from('profiles')
  .select('id, email')
  .eq('email', email)
  .single();

if (existingEmailProfile) {
  return c.json({ 
    error: 'Email already registered',
    message: 'This email is already registered. Please use Sign In instead.',
    messageAr: 'ูุฐุง ุงูุจุฑูุฏ ูุณุฌู ูุณุจูุงู. ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุชุณุฌูู ุงูุฏุฎูู.'
  }, 400);
}
```

### 2. ูุนุงูุฌุฉ ุฎุทุฃ ุงูููุชุงุญ ุงูููุฑุฑ
```typescript
if (profileError) {
  // Check if it's a duplicate key error
  if (profileError.message.includes('duplicate key') || profileError.code === '23505') {
    console.log('โ๏ธ Profile already exists, attempting to fetch existing profile...');
    
    // Try to get the existing profile
    const { data: existingProfile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', authData.user.id)
      .single();
    
    if (existingProfile) {
      return c.json({ 
        message: 'User profile retrieved successfully',
        user: existingProfile
      });
    }
  }
  
  // If profile creation fails, delete the auth user
  await supabase.auth.admin.deleteUser(authData.user.id);
  
  return c.json({ 
    error: 'Failed to create profile',
    details: profileError.message
  }, 500);
}
```

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### 1๏ธโฃ ุฅุนุงุฏุฉ ูุดุฑ Edge Function

```bash
chmod +x deploy-edge-function.sh
./deploy-edge-function.sh
```

**โฑ๏ธ ุงูููุช:** ุฏูููุฉ ูุงุญุฏุฉ

---

### 2๏ธโฃ ุชูุธูู ุงููุณุชุฎุฏููู ุงูููุฑุฑูู (ุงุฎุชูุงุฑู)

ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏููู ููุฑุฑูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

```sql
-- 1. ุงูุชุญ Supabase Dashboard > SQL Editor
-- 2. ุงูุตู ุงูููุฏ ุงูุชุงูู ูููุญุต

SELECT 
    u.id,
    u.email,
    u.created_at as auth_created,
    p.id as profile_id,
    p.full_name,
    p.role
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
ORDER BY u.created_at DESC
LIMIT 20;
```

**ุฅุฐุง ูุฌุฏุช ูุณุชุฎุฏููู ุจุฏูู profiles:**

```sql
-- ุญุฐู ุงููุณุชุฎุฏููู ูู Auth ุงูุฐูู ููุณ ูุฏููู profiles
DELETE FROM auth.users
WHERE id NOT IN (
    SELECT id FROM profiles
);
```

**ุฃู ุงุณุชุฎุฏู ุงูุณูุฑุจุช ุงูุฌุงูุฒ:**

ุฑุงุฌุน ููู: `cleanup-duplicate-users.sql`

---

### 3๏ธโฃ ุงุฎุชุจุงุฑ ุงูุชุณุฌูู

```bash
# ุงุฎุชุจุฑ ุงููุธุงู
./test-complete-system.sh
```

**ุฃู ุงุฎุชุจุฑ ูู ุงููุชุตูุญ:**

1. ุงูุชุญ ุงููุธุงู
2. ุงุถุบุท "ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ"
3. ุฃุฏุฎู ุจุฑูุฏ ุฌุฏูุฏ: `newuser@kku.edu.sa`
4. ุฃููู ุงูุชุณุฌูู

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ
```

---

## ๐ ููู ุงููุดููุฉ ุจุงูุชูุตูู

### ุงููุดููุฉ ุงูุฃุตููุฉ:

```
1. ุงููุณุชุฎุฏู ูุญุงูู ุงูุชุณุฌูู ุจู: user@kku.edu.sa
2. ุงููุธุงู ูููู ุจู:
   a. ุฅูุดุงุก user ูู auth.users โ
   b. ูุญุงููุฉ ุฅูุดุงุก profile ูู profiles โ
3. ุงูุฎุทุฃ: ุงููุณุชุฎุฏู ููุฌูุฏ ูุณุจูุงู!
```

### ุงูุญู ุงููุทุจู:

```
1. ุงููุณุชุฎุฏู ูุญุงูู ุงูุชุณุฌูู ุจู: user@kku.edu.sa
2. ุงููุธุงู ูููู ุจู:
   a. ูุญุต ุฅุฐุง ูุงู ุงูุจุฑูุฏ ููุฌูุฏ ูู profiles
   b. ุฅุฐุง ููุฌูุฏ โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
   c. ุฅุฐุง ุบูุฑ ููุฌูุฏ โ ุงููุชุงุจุนุฉ
3. ุนูุฏ ุงูุฅูุดุงุก:
   a. ุฅูุดุงุก user ูู auth.users
   b. ูุญุงููุฉ ุฅูุดุงุก profile
   c. ุฅุฐุง ูุดู ุจุณุจุจ duplicate:
      - ูุญุงููุฉ ุงุณุชุฑุฌุงุน profile ุงูููุฌูุฏ
      - ุฅุฐุง ูุฌุญ โ ุฅุฑุฌุงุน ุงูุจูุงูุงุช
      - ุฅุฐุง ูุดู โ ุญุฐู auth user
```

---

## ๐ ุงูุญุงูุงุช ุงูููููุฉ

### ุงูุญุงูุฉ 1: ูุณุชุฎุฏู ุฌุฏูุฏ ุชูุงูุงู โ
```
Email: newuser@kku.edu.sa (ุบูุฑ ููุฌูุฏ)
โ ุฅูุดุงุก auth.user โ
โ ุฅูุดุงุก profile โ
โ ุงููุชูุฌุฉ: ุชุณุฌูู ูุงุฌุญ
```

### ุงูุญุงูุฉ 2: ุงูุจุฑูุฏ ูุณุฌู ูุณุจูุงู โ๏ธ
```
Email: existing@kku.edu.sa (ููุฌูุฏ ูู profiles)
โ ุงููุญุต ููุชุดู ุงููุฌูุฏ
โ ุงููุชูุฌุฉ: "ุงูุจุฑูุฏ ูุณุฌู ูุณุจูุงู. ุงุณุชุฎุฏู ุชุณุฌูู ุงูุฏุฎูู"
```

### ุงูุญุงูุฉ 3: ููุฌูุฏ ูู Auth ููุท (ูุงุฏุฑ) ๐
```
Email: orphan@kku.edu.sa (ููุฌูุฏ ูู auth ููุท)
โ ุฅูุดุงุก auth.user (ูุฏ ููุดู)
โ ุฅุฐุง ูุฌุญ โ ุฅูุดุงุก profile
โ ุงููุชูุฌุฉ: ุชุณุฌูู ูุงุฌุญ ุฃู ุฑุณุงูุฉ "ุงูุจุฑูุฏ ูุณุฌู"
```

### ุงูุญุงูุฉ 4: Duplicate Key Error (ูุญููู ุงูุขู) โ
```
Email: duplicate@kku.edu.sa
โ ุฅูุดุงุก auth.user โ
โ ูุญุงููุฉ ุฅูุดุงุก profile โ (duplicate)
โ ุงุณุชุฑุฌุงุน profile ุงูููุฌูุฏ โ
โ ุงููุชูุฌุฉ: ุฅุฑุฌุงุน ุงูุจูุงูุงุช ุจูุฌุงุญ
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

### ุงุฎุชุจุงุฑ 1: ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ

```javascript
// ูู ุงููุชุตูุญ Console
const response = await fetch('https://pcymgqdjbdklrikdquih.supabase.co/functions/v1/make-server-90ad488b/signup', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_ANON_KEY'
  },
  body: JSON.stringify({
    email: 'test123@kku.edu.sa',
    password: 'Test@1234',
    full_name: 'ุงุฎุชุจุงุฑ ุงููุธุงู',
    role: 'student',
    university_id: '441111111'
  })
});

const data = await response.json();
console.log(data);
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "message": "User created successfully",
  "messageAr": "ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ",
  "user": { ... }
}
```

---

### ุงุฎุชุจุงุฑ 2: ูุญุงููุฉ ุชุณุฌูู ุจููุณ ุงูุจุฑูุฏ

```javascript
// ููุณ ุงูููุฏ ุฃุนูุงู ูุฑุฉ ุฃุฎุฑู
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "error": "Email already registered",
  "message": "This email is already registered. Please use Sign In instead.",
  "messageAr": "ูุฐุง ุงูุจุฑูุฏ ูุณุฌู ูุณุจูุงู. ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุชุณุฌูู ุงูุฏุฎูู."
}
```

---

## ๐ ุฃูุงู ุฅุถุงูู

### ุงูุชุญุณููุงุช ุงููุทุจูุฉ:

1. โ **ูุญุต ูุณุจู ููุจุฑูุฏ** - ููุน ุงูุชูุฑุงุฑ ูู ุงูุจุฏุงูุฉ
2. โ **ูุนุงูุฌุฉ Duplicate Key** - ุงุณุชุฑุฌุงุน Profile ููุฌูุฏ
3. โ **ุชูุธูู Auth Users** - ุญุฐู auth user ุนูุฏ ูุดู Profile
4. โ **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ** - ุนุฑุจู/ุฅูุฌููุฒู
5. โ **Logging ูุญุณูู** - ุชุชุจุน ุฃูุถู ููุฃุฎุทุงุก

---

## ๐ ูุงุฆูุฉ ุงูุชุญูู

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:

- [ ] ุฃุนุฏุช ูุดุฑ Edge Function
- [ ] ุงุฎุชุจุฑุช ุงูุชุณุฌูู ุจูุณุชุฎุฏู ุฌุฏูุฏ
- [ ] ุญุงููุช ุงูุชุณุฌูู ุจููุณ ุงูุจุฑูุฏ (ูุฌุจ ุฃู ููุดู)
- [ ] ูุญุตุช Console ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [ ] ูุธูุช ุงููุณุชุฎุฏููู ุงูููุฑุฑูู (ุฅุฐุง ูุฒู)

---

## ๐ก ูุตุงุฆุญ ูููุณุชูุจู

### ูุชุฌูุจ ูุฐู ุงููุดููุฉ:

1. **ูุง ุชุญุฐู Profiles ูุฏููุงู** - ุงุญุฐู ูู Auth ุฃููุงู
2. **ุงุณุชุฎุฏู ูุงุฌูุฉ ุงููุธุงู** - ููุชุณุฌูู ูุงูุญุฐู
3. **ุฑุงุฌุน Logs** - ูุจู ุงูุญุฐู ุงููุฏูู
4. **ุงุณุชุฎุฏู ุณูุฑุจุช ุงูุชูุธูู** - `cleanup-duplicate-users.sql`

---

## ๐จ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุงูุฎุทูุฉ 1: ูุญุต Logs
```
Supabase Dashboard > Functions > server > Logs
```

ุงุจุญุซ ุนู:
- `๐ Checking if email exists`
- `โ User created in Auth`
- `โ Profile creation error`

---

### ุงูุฎุทูุฉ 2: ูุญุต Database
```sql
-- ูู SQL Editor
SELECT 
    COUNT(*) as auth_users 
FROM auth.users;

SELECT 
    COUNT(*) as profiles 
FROM profiles;

-- ูุฌุจ ุฃู ููููุง ูุชุณุงูููู ุฃู ูุชูุงุฑุจูู
```

---

### ุงูุฎุทูุฉ 3: ุฑุงุฌุน ุงูููุฏ
```
/supabase/functions/server/index.tsx
```

ุชุฃูุฏ ูู:
- ุณุทุฑ 193: ูุญุต ุงูุจุฑูุฏ ุงูููุฌูุฏ
- ุณุทุฑ 220: ูุนุงูุฌุฉ duplicate key error
- ุณุทุฑ 234: ุญุฐู auth user ุนูุฏ ุงููุดู

---

## ๐ ุงูุฏุนู

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:

1. **ูุญุต Console** (F12)
2. **ูุญุต Network** (ุชุจููุจ Network)
3. **ูุญุต Supabase Logs**
4. **ุฑุงุฌุน:** `TROUBLESHOOTING_AR.md`
5. **ูุธู Database:** `cleanup-duplicate-users.sql`

---

## โ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅุตูุงุญู:
- โ ูุญุต ูุณุจู ููุจุฑูุฏ ุงูุฅููุชุฑููู
- โ ูุนุงูุฌุฉ ุฎุทุฃ ุงูููุชุงุญ ุงูููุฑุฑ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุชูุธูู ุชููุงุฆู ููุจูุงูุงุช

### ุงูุฎุทูุฉ ุงูุชุงููุฉ:
```bash
# 1. ุฃุนุฏ ูุดุฑ Edge Function
./deploy-edge-function.sh

# 2. ุงุฎุชุจุฑ ุงููุธุงู
./test-complete-system.sh

# 3. ุฌุฑุจ ุงูุชุณุฌูู ูู ุงููุชุตูุญ
npm run dev
```

---

<div align="center">

**โ ุชู ุญู ุงููุดููุฉ!**

**ุงูุขู ููููู ุงูุชุณุฌูู ุจุฏูู ุฃุฎุทุงุก**

---

**๐ ูุธุงู ุงูุญุถูุฑ ุงูุฐูู - ุฌุงูุนุฉ ุงูููู ุฎุงูุฏ**

</div>
