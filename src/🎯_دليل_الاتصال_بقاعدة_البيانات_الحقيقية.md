# ๐ฏ ุฏููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญููููุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ุงููุธุงู ุจุงููุงูู ููุณุชุฎุฏู **ูุงุนุฏุฉ ุจูุงูุงุช PostgreSQL ุงูุญููููุฉ** ุจุฏูุงู ูู kv_store.

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ุชุญุฏูุซ Edge Functions (`/supabase/functions/server/index.tsx`)

#### ูุจู ุงูุชุญุฏูุซ โ
```typescript
// ูุงู ูุณุชุฎุฏู kv_store
await kv.set(`user:${userId}`, userData);
const user = await kv.get(`user:${userId}`);
```

#### ุจุนุฏ ุงูุชุญุฏูุซ โ
```typescript
// ุงูุขู ูุณุชุฎุฏู SQL
await db.createUser(userData);
const user = await db.getUserByAuthId(authId);
```

### 2. ุฌููุน ุงูู Endpoints ูุญุฏุซุฉ

| Endpoint | ุงููุธููุฉ | ุงูุฌุฏูู ุงููุณุชุฎุฏู |
|----------|---------|-----------------|
| `POST /signup` | ุงูุชุณุฌูู | `users` |
| `GET /me` | ุจูุงูุงุช ุงููุณุชุฎุฏู | `users` |
| `POST /session/register` | ุชุณุฌูู ุฌูุณุฉ | `device_sessions` |
| `POST /courses` | ุฅูุดุงุก ููุฑุฑ | `courses` |
| `GET /courses` | ุนุฑุถ ุงูููุฑุฑุงุช | `courses`, `enrollments` |
| `POST /sessions` | ุฅูุดุงุก ุฌูุณุฉ ุญุถูุฑ | `sessions` |
| `POST /attendance/verify` | ุชุณุฌูู ุงูุญุถูุฑ | `attendance_records` |
| `GET /notifications` | ุงูุฅุดุนุงุฑุงุช | `notifications` |
| `GET /stats/dashboard` | ุงูุฅุญุตุงุฆูุงุช | ุฌููุน ุงูุฌุฏุงูู |

### 3. ุชุญุฏูุซ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ

ุงูุฃุฑูุงู ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุงูุขู **ููููุฉ (0)** ููุง ุทูุจุช:
```typescript
return {
  studentsCount: 0,
  instructorsCount: 0,
  coursesCount: 0,
  attendanceRate: 0
};
```

## ๐ง ุฎุทูุงุช ุงูุชุดุบูู

### ุงูุฎุทูุฉ 1: ุงูุชุฃูุฏ ูู ุชูููุฐ SQL Schema

1. ุงูุชุญ **Supabase Dashboard**: https://app.supabase.com
2. ุงุฎุชุฑ ูุดุฑูุนู
3. ุงุฐูุจ ุฅูู **SQL Editor** ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
4. ุงูุณุฎ ูุญุชูู ุงูููู `/DATABASE_SETUP_CLEAN.sql`
5. ุงูุตู ูู SQL Editor ูุงุถุบุท **Run**

### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ุงูุฌุฏุงูู

ุจุนุฏ ุชูููุฐ SQLุ ุชุญูู ูู ูุฌูุฏ ูุฐู ุงูุฌุฏุงูู ูู **Table Editor**:

```
โ users
โ device_sessions
โ courses
โ enrollments
โ schedules
โ sessions
โ attendance_records
โ notifications
โ activity_logs
โ system_settings
```

### ุงูุฎุทูุฉ 3: ุฑูุน Edge Functions

ุนูุฏ ุฑูุน ุงููุดุฑูุน ุนูู Vercel ุฃู ุฃู ููุตุฉ ุฃุฎุฑูุ ุชุฃูุฏ ูู:

1. ููู `index.tsx` ููุฌูุฏ ูู `/supabase/functions/server/`
2. ููู `db.ts` ููุฌูุฏ ูู `/supabase/functions/server/`
3. Environment Variables ูุญุฏุฏุฉ ุจุดูู ุตุญูุญ

## ๐ Row Level Security (RLS)

ุฌููุน ุงูุฌุฏุงูู ูุญููุฉ ุจู RLS:

### ุณูุงุณุงุช ุงูุทูุงุจ
- โ ูุฑูู ููุท ุจูุงูุงุชูู ุงูุฎุงุตุฉ ูู `users`
- โ ูุฑูู ููุท ููุฑุฑุงุชูู ูู `enrollments`
- โ ูุฑูู ููุท ุญุถูุฑูู ูู `attendance_records`
- โ ูุฑูู ููุท ุฅุดุนุงุฑุงุชูู ูู `notifications`

### ุณูุงุณุงุช ุงููุฏุฑุณูู
- โ ูุฑูู ุฌููุน ุงูุทูุงุจ (read-only)
- โ ูุฑูู ููุฑุฑุงุชูู ููุท ูู `courses`
- โ ูุฏูุฑูู ุฌูุณุงุชูู ููุท ูู `sessions`
- โ ูุฑูู ุญุถูุฑ ุทูุงุจูู ููุท

### ุณูุงุณุงุช ุงููุฏุฑุงุก
- โ ูุตูู ูุงูู ูุฌููุน ุงูุฌุฏุงูู
- โ ุฅูุดุงุก ูุชุนุฏูู ูุญุฐู

## ๐ ุฃูุซูุฉ ุนูู ุงูุงุณุชุนูุงูุงุช

### 1. ุงูุญุตูู ุนูู ุฌููุน ุงูุทูุงุจ
```sql
SELECT * FROM users WHERE role = 'student';
```

### 2. ุงูุญุตูู ุนูู ููุฑุฑุงุช ูุฏุฑุณ
```sql
SELECT * FROM courses WHERE instructor_id = 'instructor-uuid';
```

### 3. ุงูุญุตูู ุนูู ุญุถูุฑ ุทุงูุจ
```sql
SELECT 
    ar.*,
    c.course_name,
    s.title as session_title
FROM attendance_records ar
JOIN courses c ON ar.course_id = c.id
JOIN sessions s ON ar.session_id = s.id
WHERE ar.student_id = 'student-uuid'
ORDER BY ar.check_in_time DESC;
```

### 4. ุฅุญุตุงุฆูุงุช ุงูููุฑุฑ
```sql
SELECT 
    c.course_name,
    COUNT(DISTINCT e.student_id) as enrolled_students,
    COUNT(DISTINCT s.id) as total_sessions,
    COUNT(DISTINCT ar.id) as total_attendance
FROM courses c
LEFT JOIN enrollments e ON c.id = e.course_id
LEFT JOIN sessions s ON c.id = s.course_id
LEFT JOIN attendance_records ar ON c.id = ar.course_id
WHERE c.id = 'course-uuid'
GROUP BY c.id, c.course_name;
```

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. ุชุณุฌูู ุทุงูุจ ุฌุฏูุฏ

```bash
curl -X POST http://localhost:8000/make-server-90ad488b/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "student@kku.edu.sa",
    "password": "Test123!",
    "full_name": "ุฃุญูุฏ ูุญูุฏ ุนูู",
    "role": "student",
    "university_id": "441234567"
  }'
```

**ุงูุชุญูู:**
```sql
SELECT * FROM users WHERE email = 'student@kku.edu.sa';
```

### 2. ุชุณุฌูู ุงูุฏุฎูู

```bash
# Frontend ูุณุชุฎุฏู Supabase Auth
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'student@kku.edu.sa',
  password: 'Test123!'
});
```

**ุงูุชุญูู:**
```sql
SELECT * FROM device_sessions WHERE user_id = 'user-uuid';
```

### 3. ุฅูุดุงุก ููุฑุฑ (ููุฏุฑุณ)

```bash
curl -X POST http://localhost:8000/make-server-90ad488b/courses \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "course_code": "CS101",
    "course_name": "Introduction to Computer Science",
    "course_name_ar": "ููุฏูุฉ ูู ุนููู ุงูุญุงุณุจ",
    "department": "Computer Science",
    "semester": "Fall 2025",
    "academic_year": "2025-2026"
  }'
```

**ุงูุชุญูู:**
```sql
SELECT * FROM courses WHERE course_code = 'CS101';
```

### 4. ุฅูุดุงุก ุฌูุณุฉ ุญุถูุฑ

```bash
curl -X POST http://localhost:8000/make-server-90ad488b/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "course_id": "course-uuid",
    "session_type": "attendance",
    "title": "ุงููุญุงุถุฑุฉ ุงูุฃููู",
    "duration_minutes": 15
  }'
```

**ุงูุชุญูู:**
```sql
SELECT * FROM sessions WHERE course_id = 'course-uuid';
```

### 5. ุชุณุฌูู ุงูุญุถูุฑ (ูุทุงูุจ)

```bash
curl -X POST http://localhost:8000/make-server-90ad488b/attendance/verify \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "code": "ABC123",
    "deviceFingerprint": "unique-fingerprint-hash"
  }'
```

**ุงูุชุญูู:**
```sql
SELECT * FROM attendance_records WHERE student_id = 'student-uuid';
```

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ: "User not found in database"

**ุงูุณุจุจ:** ุงููุณุชุฎุฏู ููุฌูุฏ ูู Supabase Auth ููู ููุณ ูู ุฌุฏูู `users`.

**ุงูุญู:**
```sql
-- ุชุญูู ูู Supabase Auth
SELECT * FROM auth.users WHERE email = 'user@kku.edu.sa';

-- ุฃุถู ุงููุณุชุฎุฏู ูุฏููุงู ุฅูู ุฌุฏูู users
INSERT INTO users (auth_id, email, full_name, role)
VALUES ('auth-uuid', 'user@kku.edu.sa', 'User Name', 'student');
```

### ุฎุทุฃ: "University ID already registered"

**ุงูุณุจุจ:** ุงูุฑูู ุงูุฌุงูุนู ูุณุชุฎุฏู ูู ูุจู.

**ุงูุญู:**
```sql
-- ุงุจุญุซ ุนู ุงููุณุชุฎุฏู ุงูุฐู ูุณุชุฎุฏู ูุฐุง ุงูุฑูู
SELECT * FROM users WHERE university_id = '441234567';
```

### ุฎุทุฃ: "Concurrent login detected"

**ุงูุณุจุจ:** ููุฌุฏ ุฌูุณุฉ ูุดุทุฉ ุนูู ุฌูุงุฒ ุขุฎุฑ.

**ุงูุญู:**
```sql
-- ุนุฑุถ ุงูุฌูุณุงุช ุงููุดุทุฉ
SELECT * FROM device_sessions 
WHERE user_id = 'user-uuid' AND is_active = true;

-- ุฅููุงุก ุงูุฌูุณุงุช ุงููุฏููุฉ
UPDATE device_sessions 
SET is_active = false 
WHERE user_id = 'user-uuid';
```

### ุฎุทุฃ: "Invalid or expired code"

**ุงูุณุจุจ:** ููุฏ ุงูุญุถูุฑ ุบูุฑ ุตุญูุญ ุฃู ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ.

**ุงูุญู:**
```sql
-- ุนุฑุถ ุงูุฌูุณุงุช ุงููุดุทุฉ
SELECT * FROM sessions WHERE is_active = true;

-- ุชุญูู ูู ุงูููุฏ
SELECT * FROM sessions WHERE code = 'ABC123';
```

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### ุนุฑุถ ุขุฎุฑ 10 ุณุฌูุงุช ูุดุงุท
```sql
SELECT 
    al.*,
    u.email as user_email,
    u.role as user_role
FROM activity_logs al
LEFT JOIN users u ON al.user_id = u.id
ORDER BY al.created_at DESC
LIMIT 10;
```

### ุนุฑุถ ุงูุฌูุณุงุช ุงููุดุทุฉ ุญุงููุงู
```sql
SELECT 
    ds.*,
    u.email,
    u.role
FROM device_sessions ds
JOIN users u ON ds.user_id = u.id
WHERE ds.is_active = true 
  AND ds.expires_at > NOW()
ORDER BY ds.created_at DESC;
```

### ุฅุญุตุงุฆูุงุช ุงูุญุถูุฑ ููููู
```sql
SELECT 
    COUNT(*) as total_attendance,
    COUNT(CASE WHEN attendance_status = 'present' THEN 1 END) as present,
    COUNT(CASE WHEN attendance_status = 'late' THEN 1 END) as late,
    COUNT(CASE WHEN attendance_status = 'absent' THEN 1 END) as absent
FROM attendance_records
WHERE DATE(check_in_time) = CURRENT_DATE;
```

## ๐ ููุงุญุธุงุช ููุฏูุชูุฑุฉ ุงููุดุฑูุฉ

### โ ุชู ุชุทุจูู ุฌููุน ุงููุชุทูุจุงุช:

1. **ูุงุนุฏุฉ ุจูุงูุงุช ุญููููุฉ** โ
   - ุฌููุน ุงูุจูุงูุงุช ุชูุฎุฒู ูู ุฌุฏุงูู PostgreSQL
   - ูุง ููุฌุฏ ุงุณุชุฎุฏุงู ูู kv_store

2. **ุงูุฃุฑูุงู ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ููููุฉ** โ
   - ุชู ุชุนููู ุฌููุน ุงูุฃุฑูุงู ุฅูู 0
   - ูุง ุชุณุชุนูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

3. **Edge Functions ูุชุตูุฉ** โ
   - ุฌููุน ุงูู endpoints ุชุณุชุฎุฏู SQL
   - ููุฌูุฏุฉ ูู `/supabase/functions/server/`

4. **ูุง ุชูุฌุฏ ุญุณุงุจุงุช ุชุฌุฑูุจูุฉ** โ
   - ุงููุธุงู ูุธูู ุชูุงูุงู
   - ููุท ุฅุนุฏุงุฏุงุช ุงููุธุงู ูู `system_settings`

5. **ุงูุชุญูู ูู ุงููููุฉ** โ
   - ูุธุงู `device_sessions` ูููุน ุงูุชุณุฌูู ุงููุชุฒุงูู
   - ุชุณุฌูู ุฌููุน ุงูุฃูุดุทุฉ ูู `activity_logs`

6. **ุงูุจุฑูุฏ ูุงูุฑูู ุงูุฌุงูุนู** โ
   - ุงูุชุญูู ูู `@kku.edu.sa`
   - ุงูุชุญูู ูู ุตูุบุฉ ุงูุฑูู ุงูุฌุงูุนู (9 ุฎุงูุงุช ุชุจุฏุฃ ุจู 44)

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุชูููุฐ SQL Schema** ูู Supabase Dashboard
2. **ุงุฎุชุจุงุฑ ุงูุชุณุฌูู** ูุฅูุดุงุก ุฃูู ูุณุชุฎุฏู
3. **ุงูุชุญูู ูู ุงูุฌุฏุงูู** ูู Table Editor
4. **ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู** ูุงูุญุถูุฑ
5. **ุนุฑุถ ุงููุธุงู** ุนูู ุงูุฏูุชูุฑุฉ ุงููุดุฑูุฉ

---

**ุงููุธุงู ุฌุงูุฒ ุงูุขู ููุนูู ุจุดูู ูุงูู ูุน ูุงุนุฏุฉ ุจูุงูุงุช SQL ุญููููุฉ! ๐**

ุชุงุฑูุฎ ุงูุชุญุฏูุซ: 9 ุฏูุณูุจุฑ 2025
