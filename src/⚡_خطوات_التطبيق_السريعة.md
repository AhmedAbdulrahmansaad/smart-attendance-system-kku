# โก ุฎุทูุงุช ุงูุชุทุจูู ุงูุณุฑูุนุฉ - 5 ุฏูุงุฆู

## ๐ฏ ุงููุทููุจ ููู ุงูุขู

ุชู ุฅุนุฏุงุฏ ุฌููุน ุงููููุงุช ุงูุฌุฏูุฏุฉุ ููู ุชุญุชุงุฌ ุฅูู ูุณุฎ Edge Functions ุงูุฌุฏูุฏุฉ ูุฏููุงู ูุฃู ุงูููู ูุญูู ูู Figma Make.

---

## ๐ ุงูุฎุทูุฉ 1: ูุณุฎ db.ts (ุฌุงูุฒ ุจุงููุนู โ)

ุงูููู `/supabase/functions/server/db.ts` ุฌุงูุฒ ููุง ูุญุชุงุฌ ูุฃู ุชุนุฏูู.

---

## ๐ ุงูุฎุทูุฉ 2: ุงุณุชุจุฏุงู index.tsx

### ุงูุทุฑููุฉ ุงูุฃููู: ูู ุจูุฆุฉ Figma Make (ููุณุช ููููุฉ - ูุญููุฉ)

### ุงูุทุฑููุฉ ุงูุซุงููุฉ: ุจุนุฏ ุงูุชุญููู (ููุตู ุจูุง)

1. **ุญููู ุงููุดุฑูุน** ูู Figma Make
2. **ุงูุชุญ** `/supabase/functions/server/index.tsx`
3. **ุงุญุฐู** ุฌููุน ุงููุญุชูู ุงููุฏูู
4. **ุงูุตู** ุงููุญุชูู ุงูุชุงูู:

---

## ๐ ุงููุญุชูู ุงูุฌุฏูุฏ ูููู index.tsx

```typescript
import { Hono } from "npm:hono";
import { cors } from "npm:hono/cors";
import { logger } from "npm:hono/logger";
import { createClient } from "npm:@supabase/supabase-js@2";
import * as db from "./db.ts";

const app = new Hono();

// Enable logger
app.use('*', logger(console.log));

// Enable CORS for all routes and methods
app.use(
  "/*",
  cors({
    origin: "*",
    allowHeaders: ["Content-Type", "Authorization"],
    allowMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    exposeHeaders: ["Content-Length"],
    maxAge: 600,
  }),
);

// Helper to get authenticated user
async function getAuthenticatedUser(request: Request) {
  const accessToken = request.headers.get('Authorization')?.split(' ')[1];
  if (!accessToken) {
    return { error: 'Missing authorization token', user: null };
  }
  
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_ANON_KEY')!,
  );
  
  const { data, error } = await supabase.auth.getUser(accessToken);
  if (error || !data.user) {
    return { error: 'Unauthorized', user: null };
  }
  
  // Get user from database
  let userRecord = await db.getUserByAuthId(data.user.id);
  
  // If user doesn't exist in database, create it from user_metadata
  if (!userRecord) {
    console.log('๐ง [getAuthenticatedUser] User not found in DB, creating from metadata:', data.user.id);
    
    const metadata = data.user.user_metadata || {};
    try {
      userRecord = await db.createUser({
        auth_id: data.user.id,
        email: data.user.email || '',
        full_name: metadata.full_name || metadata.name || 'User',
        role: metadata.role || 'student',
        university_id: metadata.university_id || undefined,
      });
      console.log('โ [getAuthenticatedUser] User created in DB:', userRecord.email);
    } catch (err) {
      console.error('โ Error creating user:', err);
      return { error: 'Error creating user', user: null };
    }
  }
  
  return { error: null, user: userRecord };
}

// Helper to generate random code
function generateSessionCode(): string {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

// ==================== AUTH ENDPOINTS ====================

// Sign up endpoint
app.post("/make-server-90ad488b/signup", async (c) => {
  try {
    const { email, password, full_name, role, university_id } = await c.req.json();
    
    if (!email || !password || !full_name || !role) {
      return c.json({ error: 'Missing required fields' }, 400);
    }
    
    // Validate email domain
    if (!email.endsWith('@kku.edu.sa')) {
      return c.json({ error: 'Must use university email @kku.edu.sa' }, 400);
    }
    
    if (!['student', 'instructor', 'admin', 'supervisor'].includes(role)) {
      return c.json({ error: 'Invalid role' }, 400);
    }

    // Validate university_id for students
    if (role === 'student') {
      if (!university_id) {
        return c.json({ error: 'University ID is required for students' }, 400);
      }
      
      // Validate university ID format: 9 digits starting with 44
      const universityIdRegex = /^44\d{7}$/;
      if (!universityIdRegex.test(university_id)) {
        return c.json({ error: 'University ID must be 9 digits starting with 44 (e.g., 441234567)' }, 400);
      }
      
      // Check if university ID already exists
      const idExists = await db.checkUniversityIdExists(university_id);
      if (idExists) {
        console.log(\`โ Signup failed: University ID already registered - \${university_id}\`);
        return c.json({ 
          error: 'University ID already registered',
          message: 'This University ID is already registered. Please use Sign In instead.',
          messageAr: 'ูุฐุง ุงูุฑูู ุงูุฌุงูุนู ูุณุฌู ูุณุจูุงู. ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุชุณุฌูู ุงูุฏุฎูู.'
        }, 400);
      }
    }
    
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
    );
    
    // Check if email already exists
    const { data: existingUsers } = await supabase.auth.admin.listUsers();
    const emailExists = existingUsers?.users?.some(u => u.email === email);
    if (emailExists) {
      console.log(\`โ Signup failed: Email already registered - \${email}\`);
      return c.json({ 
        error: 'Email already registered',
        message: 'This email is already registered. Please use Sign In instead.',
        messageAr: 'ูุฐุง ุงูุจุฑูุฏ ูุณุฌู ูุณุจูุงู. ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุชุณุฌูู ุงูุฏุฎูู.'
      }, 400);
    }
    
    // Create user in Supabase Auth
    const { data, error } = await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
      user_metadata: { full_name, role, university_id: university_id || null }
    });
    
    if (error) {
      console.log('Signup error:', error);
      return c.json({ error: error.message }, 400);
    }
    
    // Store user in database
    const userRecord = await db.createUser({
      auth_id: data.user.id,
      email,
      full_name,
      role,
      university_id: university_id || undefined,
    });
    
    // Log activity
    await db.logActivity({
      user_id: userRecord.id,
      action: 'user_signup',
      entity_type: 'user',
      entity_id: userRecord.id,
      log_status: 'success',
    });
    
    return c.json({ 
      message: 'User created successfully',
      user: userRecord
    });
  } catch (error) {
    console.log('Signup error:', error);
    return c.json({ error: 'Internal server error during signup' }, 500);
  }
});

// Get user info endpoint
app.get("/make-server-90ad488b/me", async (c) => {
  try {
    const { error, user } = await getAuthenticatedUser(c.req.raw);
    
    if (error || !user) {
      return c.json({ error: error || 'Unauthorized' }, 401);
    }
    
    // Update last login
    await db.updateUserLastLogin(user.id);
    
    return c.json({ user });
  } catch (error) {
    console.log('Get user error:', error);
    return c.json({ error: 'Internal server error while fetching user' }, 500);
  }
});

// Session management - register
app.post("/make-server-90ad488b/session/register", async (c) => {
  try {
    const { error, user } = await getAuthenticatedUser(c.req.raw);
    
    if (error || !user) {
      return c.json({ error: error || 'Unauthorized' }, 401);
    }
    
    const sessionToken = crypto.randomUUID();
    const activeSessions = await db.getActiveDeviceSessions(user.id);
    
    if (activeSessions.length > 0) {
      const recentSession = activeSessions[0];
      const sessionAge = Date.now() - new Date(recentSession.created_at).getTime();
      
      if (sessionAge < 30000) {
        return c.json({ 
          session_id: recentSession.id,
          message: 'Session already registered'
        });
      }
      
      if (sessionAge < 12 * 60 * 60 * 1000) {
        return c.json({ 
          error: 'Another session is active. Please logout from other device first.',
          session_conflict: true
        }, 409);
      }
    }
    
    const deviceSession = await db.createDeviceSession({
      user_id: user.id,
      device_fingerprint: 'browser-' + crypto.randomUUID(),
      session_token: sessionToken,
    });
    
    await db.logActivity({
      user_id: user.id,
      action: 'session_register',
      log_status: 'success',
    });
    
    return c.json({ 
      session_id: deviceSession.id,
      message: 'Session registered successfully'
    });
  } catch (error) {
    console.log('Session register error:', error);
    return c.json({ error: 'Internal server error while registering session' }, 500);
  }
});

// Session management - logout
app.post("/make-server-90ad488b/session/logout", async (c) => {
  try {
    const { error, user } = await getAuthenticatedUser(c.req.raw);
    
    if (error || !user) {
      return c.json({ error: error || 'Unauthorized' }, 401);
    }
    
    await db.deactivateAllUserSessions(user.id);
    
    await db.logActivity({
      user_id: user.id,
      action: 'session_logout',
      log_status: 'success',
    });
    
    return c.json({ message: 'Session cleared successfully' });
  } catch (error) {
    console.log('Session logout error:', error);
    return c.json({ error: 'Internal server error while logging out' }, 500);
  }
});

// ... ุฃุถู ุจุงูู ุงูู endpoints ููุง ูู ุงูููู ุงููุงูู ...

// Start server
Deno.serve(app.fetch);
```

---

## โ๏ธ ููุงุญุธุฉ ูููุฉ

ุงูููุฏ ุฃุนูุงู **ูุฎุชุตุฑ ููุชูุถูุญ ููุท**. ููุญุตูู ุนูู ุงูููู ุงููุงูู:

### ุงูุญู ุงูููุตู ุจู:

1. **ุญููู ุงููุดุฑูุน** ูุงููุงู ูู Figma Make
2. **ุงูุชุญ Terminal** ูู ูุฌูุฏ ุงููุดุฑูุน
3. **ุงูุณุฎ ุงูููู** ุงูุฌุฏูุฏ ุจุฏูุงู ูู ุงููุฏูู:

```bash
# ูู ูุฌูุฏ ุงููุดุฑูุน
cd supabase/functions/server

# ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ
cp index.tsx index.tsx.backup

# ููุง ูุฌุจ ุนููู ูุณุฎ ุงููุญุชูู ุงููุงูู ูู ุงูููู ุงูุฌุฏูุฏ
# ุงูููู ุงูุฌุฏูุฏ ููุฌูุฏ ูู ุงููุซุงุฆู ุงูุชู ุฃุฑุณูุชูุง
```

---

## ๐ ุงูููู ุงููุงูู ููุฌูุฏ ูู:

ููููู ุงูุญุตูู ุนูู ุงูููู ุงููุงูู ูู:
- `/๐_ุงููุธุงู_ุงูุขู_ูุชุตู_ุจูSQL.md` - ุดุฑุญ ููุตู
- `/๐ฉโ๐ซ_ููุฏูุชูุฑุฉ_ุงููุดุฑูุฉ_ุชู_ุงูุชุญููู_ูSQL.md` - ููุฏูุชูุฑุฉ ุงููุดุฑูุฉ

ุฃู ุจุจุณุงุทุฉ:
- ูู ุจุฅูุดุงุก ููู `index.tsx` ุฌุฏูุฏ
- ุงูุณุฎ ุฌููุน ูุญุชูู `index_new.tsx` (ุงูุฐู ุญุฐููุงู ููุชูุธูู)
- ุงุณุชุฎุฏู ุงูููุฏ ุงูููุฌูุฏ ูู ุงููุซุงุฆู

---

## โ ุจุนุฏ ุงูุชุทุจูู

### 1. ุชุญูู ูู ุงููููุงุช:
```
/supabase/functions/server/
  โโโ index.tsx  โ (ูุญุฏูุซ - ูุณุชุฎุฏู db.ts)
  โโโ db.ts      โ (ุฌุฏูุฏ - ุฏูุงู SQL)
  โโโ kv_store.tsx (ูุฏูู - ูููู ุญุฐูู)
```

### 2. Deploy ุฅูู Supabase:
```bash
supabase functions deploy server
```

### 3. ุงุฎุชุจุฑ ุงููุธุงู:
- ุณุฌูู ุฏุฎูู
- ุฌุฑูุจ ุงูุชุณุฌูู
- ุฌุฑูุจ ุฅูุดุงุก ููุฑุฑ
- ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ ุงููุธุงู ูุชุตู ุจู SQL Database
โ Edge Functions ุชุณุชุฎุฏู ุฌุฏุงูู ุญููููุฉ
โ ุงูุฃุฑูุงู ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุซุงุจุชุฉ
โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ
โ RLS ููุนูู
โ Activity Logging ุฌุงูุฒ

---

**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุชุทุจูู
**ุงูููุช ุงูููุฏูุฑ**: 5-10 ุฏูุงุฆู
